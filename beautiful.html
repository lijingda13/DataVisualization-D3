<!DOCTYPE html>
<html>
<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <title>Interactive D3 Energy and CO2 Emissions Linegraph</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        svg {
            background-color: #b7abec;
            display: block;
            margin: 0 auto; /* Center horizontally */
        }
        .line {
            fill: none;
            stroke-width: 2px;
        }
        .line-energy {
            stroke: steelblue;
        }
        .line-co2 {
            stroke: orange;
        }
        .axis text {
            font-size: 12px;
        }
        .axis path,
        .axis line {
            fill: none;
            stroke: #777;
            shape-rendering: crispEdges;
        }
        .axis .tick line {
            stroke-opacity: 0.1;
        }
        .select-container {
            margin-bottom: 20px;
            text-align: center; /* Center the select container */
        }
        .select-container select {
            padding: 5px;
            font-size: 14px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 150px; /* Set the width */
        }
        .unit-label {
            font-size: 14px;
            fill: #333;
            text-anchor: middle;
        }
        .y-axis-label {
            font-size: 14px;
            fill: #333;
            text-anchor: middle;
        }
    </style>
</head>
<body>
    <h2>Interactive Energy and CO2 Emissions Line Graph</h2>
    <div class="select-container">
        <label for="country-select">Select Country:</label>
        <select id="country-select"></select>
    </div>

    <script>
        (async () => {
            const dataPath = "data/global-data-on-sustainable-energy.csv"; // Ensure this is the correct path to your dataset
            const width = 800;
            const height = 600;
            const margin = { top: 20, right: 80, bottom: 50, left: 100 }; // Adjusted left margin

            // Data converter
            const rowConverter = (d) => ({
                Entity: d.Entity,
                date: new Date(+d.Year, 0),
                energy: +d['Renewable energy share in the total final energy consumption (%)'],
                co2: +d['Value_co2_emissions_kt_by_country']/1000000 // Adjust for your dataset's CO2 column name
            });

            // Load and transform data
            let allData = await d3.csv(dataPath, rowConverter);
            let data = allData.filter(d => d.date.getFullYear() < 2020); // Filter for years 2000 to 2019

            // Get unique countries from the data
            const countries = Array.from(new Set(data.map(d => d.Entity)));
            
            // Populate the dropdown with countries
            d3.select("#country-select")
              .selectAll('option')
              .data(countries)
              .enter()
              .append('option')
              .text(d => d)
              .attr('value', d => d);

            // Group data by country
            let groupedData = d3.group(data, d => d.Entity);

            // Create scales
            const xScale = d3.scaleTime().domain(d3.extent(data, d => d.date)).range([margin.left, width - margin.right]);
            const yScaleEnergy = d3.scaleLinear().domain([0, d3.max(data, d => d.energy)]).range([height - margin.bottom, margin.top]);
            const yScaleCo2 = d3.scaleLinear().domain([0, d3.max(data, d => d.co2)]).range([height - margin.bottom, margin.top]);

            // Create SVG container
            const svg = d3.select("body").append("svg").attr("width", width).attr("height", height);

            // Create axes
            const xAxis = d3.axisBottom(xScale).tickFormat(d3.timeFormat("%Y"));
            const yAxisLeft = d3.axisLeft(yScaleEnergy);
            const yAxisRight = d3.axisRight(yScaleCo2);

            // Append axes to SVG
            svg.append("g").attr("class", "x axis").attr("transform", `translate(0,${height - margin.bottom})`).call(xAxis);
            svg.append("g").attr("class", "y axis").attr("transform", `translate(${margin.left},0)`).call(yAxisLeft);
            svg.append("g").attr("class", "y axis").attr("transform", `translate(${width - margin.right},0)`).call(yAxisRight);

            // Append Y axis label for Energy
            svg.append("text")
                .attr("class", "y-axis-label")
                .attr("transform", `translate(${margin.left / 4 + 20}, ${height / 2}) rotate(-90)`)
                .text("Renewable Energy Share in the Total Final Energy Consumption (%)");

            // Append Y axis label for CO2 Emissions on the right Y axis
            svg.append("text")
                .attr("class", "unit-label")
                .attr("transform", `translate(${width - margin.right / 3 * 2 + 20}, ${height / 2}) rotate(90)`)
                .text("CO2 Emissions (Megatons Per Capita)");

            // Line generators
            const lineGeneratorEnergy = d3.line().x(d => xScale(d.date)).y(d => yScaleEnergy(d.energy)).curve(d3.curveMonotoneX);
            const lineGeneratorCo2 = d3.line().x(d => xScale(d.date)).y(d => yScaleCo2(d.co2)).curve(d3.curveMonotoneX);

            // Update line graph based on selected country
            function updateLineGraph(selectedCountry) {
                const countryData = groupedData.get(selectedCountry);

                // Update energy line
                const lineEnergy = svg.selectAll(".line-energy").data([countryData], d => d.Entity);
                lineEnergy.enter().append("path").attr("class", "line line-energy").merge(lineEnergy).transition().attr("d", lineGeneratorEnergy);

                // Update CO2 line
                const lineCo2 = svg.selectAll(".line-co2").data([countryData], d => d.Entity);
                lineCo2.enter().append("path").attr("class", "line line-co2").merge(lineCo2).transition().attr("d", lineGeneratorCo2);

                // Remove exiting lines
                lineEnergy.exit().remove();
                lineCo2.exit().remove();
            }

            // Listen for dropdown changes
            d3.select("#country-select").on("change", function(event) {
                updateLineGraph(event.target.value); // Update graph based on selected country
            });

            // Initial graph setup
            updateLineGraph(countries[0]); // Default to the first country in the list
        })();
    </script>
</body>
</html>