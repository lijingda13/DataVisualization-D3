<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Integrated D3.js and MapboxGL Charts</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        #map {
            width: 940px;
            height: 400px;
        }

        .map-overlay,
        #slider-container {
            padding: 10px;
            background: rgba(255, 255, 255, 0.8);
        }

        .axis-label {
            font-size: 14px;
        }

        .tooltip {
            position: absolute;
            text-align: center;
            padding: 6px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
            pointer-events: none;
            opacity: 0;
        }

        .slider-label {
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div id='map'></div>
    <div id="slider-container">
        <label for="year">Year: </label>
        <input type="range" id="year" min="2000" max="2020" value="2000">
        <span id="year-value">2000</span>
    </div>
    <svg width="560" height="400"></svg>

    <script>
        // 全局变量用于存储数据
        var globalData;

        // Mapbox地图初始化
        mapboxgl.accessToken = 'pk.eyJ1Ijoiamw0MDQiLCJhIjoiY2x1ZWN4emR3MHpuNTJpcGd6Y245djFiMCJ9.iej5RcteQI30JxjoSwMqWA';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v10',
            center: [0, 20],
            zoom: 1
        });

        // D3图表初始化
        var svg = d3.select("svg"),
            margin = { top: 20, right: 20, bottom: 60, left: 50 },
            width = +svg.attr("width") - margin.left - margin.right,
            height = +svg.attr("height") - margin.top - margin.bottom;

        var g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        var tooltip = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 0);

        // 对数比例尺
        var x = d3.scaleLog().range([0, width]).base(10),
            y = d3.scaleLog().range([height, 0]).base(10),
            z = d3.scaleLinear().range([4, 20]);

        // 加载并存储原始数据
        d3.csv("data/global-data-on-sustainable-energy.csv").then(function (data) {
            globalData = data; // 不对原始数据进行过滤

            // 过滤出有效数据
            var validData = globalData.filter(function (d) {
                return +d.Population_total > 0 && +d["Renewable-electricity-generating-capacity-total"] > 0;
            });

            // D3图表比例尺设置
            x.domain(d3.extent(validData, function (d) { return +d.Population_total; })).nice();
            y.domain(d3.extent(validData, function (d) { return +d["Renewable-electricity-generating-capacity-total"]; })).nice();
            z.domain(d3.extent(validData, function (d) { return +d.gdp_total; })).nice();

            // 绘制D3图表的轴
            g.append("g").attr("transform", "translate(0," + height + ")").call(d3.axisBottom(x)).append("text").attr("fill", "#000").attr("x", width).attr("y", 35).attr("text-anchor", "end").text("Population");
            g.append("g").call(d3.axisLeft(y)).append("text").attr("fill", "#000").attr("transform", "rotate(-90)").attr("y", -40).attr("dy", "0.71em").attr("text-anchor", "end").text("Renewable Energy Capacity (MW)");

            // Mapbox地图加载完成后的回调
            map.on('load', function () {
                updateMapboxLayer(globalData.filter(d => +d.Year == 2000)); // 使用原始数据，但过滤特定年份
            });

            // 初始化D3图表
            var filteredData = validData.filter(function (d) {
                return +d.Year === 2000;
            });
            updateChartScatter(filteredData);
        });

        // 时间滑动条事件监听器
        d3.select("#year").on("input", function () {
            var year = this.value;
            d3.select("#year-value").text(year);
            var filteredData = globalData.filter(function (d) {
                return +d.Year == year && +d.Population_total > 0 && +d["Renewable-electricity-generating-capacity-total"] > 0;
            });

            updateMapboxLayer(globalData.filter(d => +d.Year == year)); // 更新Mapbox图层，使用原始数据过滤特定年份
            updateChartScatter(filteredData); // 更新D3图表，使用筛选和验证过的数据
        });

        function updateCharts(year) {
            var filteredData = globalData.filter(function (d) {
                return d.Year == year;
            });

            // 更新Mapbox图层
            updateMapboxLayer(globalData.filter(d => +d.Year == year)); // 更新Mapbox图层，使用原始数据过滤特定年份

            // 更新D3图表
            updateChartScatter(filteredData);
        }

        function updateMapboxLayer(filteredData) {
            var geojsonData = {
                type: 'FeatureCollection',
                features: filteredData.map(function (d) {
                    return {
                        type: 'Feature',
                        properties: { access_to_electricity: parseFloat(d['Access to electricity (% of population)']) },
                        geometry: { type: 'Point', coordinates: [parseFloat(d.Longitude), parseFloat(d.Latitude)] }
                    };
                })
            };

            if (map.getLayer('electricityAccessLayer')) {
                map.removeLayer('electricityAccessLayer');
                map.removeSource('electricityAccess');
            }

            map.addSource('electricityAccess', { type: 'geojson', data: geojsonData });
            map.addLayer({
                id: 'electricityAccessLayer',
                type: 'circle',
                source: 'electricityAccess',
                paint: {
                    'circle-radius': ['interpolate', ['linear'], ['get', 'access_to_electricity'], 0, 1, 100, 8],
                    'circle-color': 'rgba(0, 255, 0, 0.5)',
                    'circle-stroke-color': '#808080',
                    'circle-stroke-width': 1
                }
            });
        }

        function updateChartScatter(filteredData) {
            var circles = g.selectAll("circle").data(filteredData, function (d) { return d.Entity; });

            circles.enter().append("circle")
                .merge(circles)
                .attr("r", function (d) { return z(+d.gdp_total); })
                .attr("cx", function (d) { return x(+d.Population_total); })
                .attr("cy", function (d) { return y(+d["Renewable-electricity-generating-capacity-total"]); })
                .style("fill", "#69b3a2")
                .style("opacity", "0.7")
                .style("stroke", "black")
                .on("mouseover", function (event, d) {
                    tooltip.transition().duration(200).style("opacity", .9);
                    tooltip.html("Country: " + d.Entity + "<br/> Year: " + d.Year + "<br/> GDP: " + d.gdp_total + "<br/> Population: " + d.Population_total + "<br/> Renewable Capacity: " + d["Renewable-electricity-generating-capacity-total"])
                        .style("left", (event.pageX) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                    tooltip.transition().duration(500).style("opacity", 0);
                });

            circles.exit().remove();
        }
    </script>
</body>

</html>